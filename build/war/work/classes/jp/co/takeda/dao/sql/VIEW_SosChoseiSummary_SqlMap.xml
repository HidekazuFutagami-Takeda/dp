<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="VIEW_SosChoseiSummary_SqlMap" >

  <resultMap id="resultMap" class="jp.co.takeda.model.view.SosChoseiSummary" >
    <result column="SOS_CD" property="sosCd" jdbcType="VARCHAR" />
    <result column="JGI_NO" property="jgiNo" jdbcType="INTEGER" />
    <result column="SOS_JGI_NAME" property="sosJgiName" jdbcType="VARCHAR" />
    <result column="MMP_HAIKA_CHOSEI_FLG" property="mmpHaikaChoseiFlg" jdbcType="CHAR" />
    <result column="SHIIRE_HAIKA_CHOSEI_FLG" property="shiireHaikaChoseiFlg" jdbcType="CHAR" />
    <result column="VACCINE_HAIKA_CHOSEI_FLG" property="vaccineHaikaChoseiFlg" jdbcType="CHAR" />
    <result column="MMP_CHOSEI_FLG" property="mmpChoseiFlg" jdbcType="CHAR" />
    <result column="MMP_CHOSEI_CATE_PICKEDUP" property="mmpChoseiCatePickedUp" jdbcType="CHAR" />
    <result column="SHIIRE_CHOSEI_FLG" property="shiireChoseiFlg" jdbcType="CHAR" />
    <result column="SHIIRE_CHOSEI_CATE_PICKEDUP" property="shiireChoseiCatePickedUp" jdbcType="CHAR" />
    <result column="VACCINE_CHOSEI_FLG" property="vaccineChoseiFlg" jdbcType="CHAR" />
    <result column="VACCINE_CHOSEI_CATE_PICKEDUP" property="vaccineChoseiCatePickedUp" jdbcType="CHAR" />
    <result column="ONC_SOS_FLG" property="oncSosFlg" jdbcType="CHAR" nullValue="0"/>


  </resultMap>

<select id="iyaku" resultMap="resultMap" parameterClass="java.util.Map">
WITH
SOS AS (
  SELECT
    '01050' AS SOS_CD
    ,PP.CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_CHOSEI_IYAKU CI
      INNER JOIN DPM_C_PLANNED_PROD PP ON CI.PROD_CODE = PP.PROD_CODE
  WHERE
    PP.CAL_YEAR = '$calYear$'
    AND PP.CAL_TERM = '$calTerm.dbValue$'
    AND CI.CAL_YEAR = '$calYear$'
    AND CI.CAL_TERM = '$calTerm.dbValue$'
    AND CI.CHOSEI_2_VALUE_Y != 0
    AND CI.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CI.DEL_FLG = '0'
  GROUP BY
    PP.CATEGORY
),
HAIKA AS (
  SELECT
    '01050' AS SOS_CD
    ,PP.CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_CHOSEI_BRANCH CB
      INNER JOIN DPM_C_VI_SOS_MST SM ON CB.SOS_CD = SM.SOS_CD
        INNER JOIN DPM_C_PLANNED_PROD PP ON CB.PROD_CODE = PP.PROD_CODE
  WHERE
    SM.BUMON_RANK = 2
    AND PP.CAL_YEAR = '$calYear$'
    AND PP.CAL_TERM = '$calTerm.dbValue$'
    AND CB.CAL_YEAR = '$calYear$'
    AND CB.CAL_TERM = '$calTerm.dbValue$'
    AND CB.CHOSEI_2_VALUE_Y != 0
    AND CB.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CB.DEL_FLG = '0'
  GROUP BY
    PP.CATEGORY
),
HAIKA_VI AS (
  SELECT
    '01050' AS SOS_CD
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_VI_CHOSEI_BRANCH CB
      INNER JOIN DPM_C_VI_SOS_MST SM ON CB.SOS_CD = SM.SOS_CD
  WHERE
    SM.BUMON_RANK = 2
    AND CB.CAL_YEAR = '$calYear$'
    AND CB.CAL_TERM = '$calTerm.dbValue$'
    AND CB.CHOSEI_2_VALUE_Y != 0
    AND CB.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CB.DEL_FLG = '0'
),
HAIKA_OFFICE AS (
  SELECT
    '01050' AS SOS_CD
    ,PP.CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_CHOSEI_OFFICE CO
      INNER JOIN DPM_C_VI_SOS_MST SM ON CO.SOS_CD = SM.SOS_CD
        INNER JOIN DPM_C_PLANNED_PROD PP ON CO.PROD_CODE = PP.PROD_CODE
  WHERE
    SM.BUMON_RANK = 3
    AND PP.CAL_YEAR = '$calYear$'
    AND PP.CAL_TERM = '$calTerm.dbValue$'
    AND CO.CAL_YEAR = '$calYear$'
    AND CO.CAL_TERM = '$calTerm.dbValue$'
    AND CO.CHOSEI_2_VALUE_Y != 0
    AND CO.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CO.DEL_FLG = '0'
  GROUP BY
    PP.CATEGORY
),
HAIKA_MR AS (
  SELECT
    '01050' AS SOS_CD
    ,PP.CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_CHOSEI_MR CM
      INNER JOIN DPM_C_PLANNED_PROD PP ON CM.PROD_CODE = PP.PROD_CODE
  WHERE
    PP.CAL_YEAR = '$calYear$'
    AND PP.CAL_TERM = '$calTerm.dbValue$'
    AND CM.CAL_YEAR = '$calYear$'
    AND CM.CAL_TERM = '$calTerm.dbValue$'
    AND CM.CHOSEI_2_VALUE_Y != 0
    AND CM.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CM.DEL_FLG = '0'
  GROUP BY
    PP.CATEGORY
)
SELECT
  SM.SOS_CD
  ,NULL AS JGI_NO
  ,'全社' AS SOS_JGI_NAME
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
  <!--  配下組織の調整計画 自社（MMP）・・・ 営業所、NSG,CV,SPBU,血液腫瘍、固形腫瘍、レア系 -->
<!--
  ,CASE
     WHEN CE_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN CE_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN CE_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN GIBU_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN GIBU_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN GIBU_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
-->
  <!--  配下組織の調整計画 自社（MMP）・・・ 仕入、ワクチン以外 -->
  ,CASE
     WHEN JISHA_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN JISHA_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN JISHA_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
     ELSE '0'
  END AS MMP_HAIKA_CHOSEI_FLG
  <!--  配下組織の調整計画 仕入品 -->
  ,CASE
     WHEN SHIIRE_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN SHIIRE_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN SHIIRE_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS SHIIRE_HAIKA_CHOSEI_FLG
  <!--  配下組織の調整計画 ワクチン品 -->
  ,CASE
     WHEN VACCINE_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN VACCINE_HAIKA_OFFICE.CHOSEI_COUNT > 0 THEN '1'
     WHEN VACCINE_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS VACCINE_HAIKA_CHOSEI_FLG
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
  <!--  調整計画 自社（MMP）・・・ 営業所、NSG,CV,SPBU,血液腫瘍、固形腫瘍、レア系 -->
<!--
  ,CASE
     WHEN CE.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG.CHOSEI_COUNT > 0 THEN '1'
     WHEN GIBU.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT .CHOSEI_COUNT > 0 THEN '1'
-->
  <!--  調整計画 自社（MMP）・・・ 仕入、ワクチン以外 -->
  ,CASE
     WHEN JISHA.CHOSEI_COUNT > 0 THEN '1'
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
     ELSE '0'
  END AS MMP_CHOSEI_FLG
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
<!--
  ,CASE
     WHEN CE.CHOSEI_COUNT > 0 THEN CE.CATEGORY
     WHEN NSG.CHOSEI_COUNT > 0 THEN NSG.CATEGORY
     WHEN GIBU.CHOSEI_COUNT > 0 THEN GIBU.CATEGORY
     WHEN ONC_BLOODTUMOR.CHOSEI_COUNT > 0 THEN ONC_BLOODTUMOR.CATEGORY
     WHEN ONC_SOLIDTUMOR.CHOSEI_COUNT > 0 THEN ONC_SOLIDTUMOR.CATEGORY
     WHEN RARE_HEMATOLOGY.CHOSEI_COUNT > 0 THEN RARE_HEMATOLOGY.CATEGORY
     WHEN RARE_IMMUNOLOGY.CHOSEI_COUNT > 0 THEN RARE_IMMUNOLOGY.CATEGORY
     WHEN RARE_METABOLIC.CHOSEI_COUNT > 0 THEN RARE_METABOLIC.CATEGORY
     WHEN NSG2.CHOSEI_COUNT > 0 THEN NSG2.CATEGORY
     WHEN RP.CHOSEI_COUNT > 0 THEN RP.CATEGORY
     WHEN RD_KAMET.CHOSEI_COUNT > 0 THEN RD_KAMET.CATEGORY
     WHEN RD_PDT .CHOSEI_COUNT > 0 THEN RD_PDT .CATEGORY
-->
  ,CASE
     WHEN JISHA.CHOSEI_COUNT > 0 THEN JISHA.CATEGORY
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
     ELSE '--'
  END AS MMP_CHOSEI_CATE_PICKEDUP
  <!-- 調整計画 仕入品 -->
  ,CASE
     WHEN SHIIRE.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS SHIIRE_CHOSEI_FLG
  ,CASE
     WHEN SHIIRE.CHOSEI_COUNT > 0 THEN SHIIRE.CATEGORY
     ELSE '--'
  END AS SHIIRE_CHOSEI_CATE_PICKEDUP
  <!-- 調整計画 ワクチン -->
  ,CASE
     WHEN VACCINE.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS VACCINE_CHOSEI_FLG
  ,CASE
     WHEN VACCINE.CHOSEI_COUNT > 0 THEN VACCINE.CATEGORY
     ELSE '--'
  END AS VACCINE_CHOSEI_CATE_PICKEDUP
  <!--  オンコロジー組織フラグ -->
  ,'0' AS ONC_SOS_FLG
FROM
  (SELECT '01050' AS SOS_CD FROM DUAL) SM
       <!-- 配下組織含む集計用 -->
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
<!--
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '01') CE_HAIKA ON SM.SOS_CD = CE_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_VI) SHIIRE_HAIKA ON SM.SOS_CD = SHIIRE_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '03') NSG_HAIKA ON SM.SOS_CD = NSG_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '04') VACCINE_HAIKA ON SM.SOS_CD = VACCINE_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '06') GIBU_HAIKA ON SM.SOS_CD = GIBU_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '07') ONC_BLOODTUMOR_HAIKA ON SM.SOS_CD = ONC_BLOODTUMOR_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '08') ONC_SOLIDTUMOR_HAIKA ON SM.SOS_CD = ONC_SOLIDTUMOR_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '09') RARE_HEMATOLOGY_HAIKA ON SM.SOS_CD = RARE_HEMATOLOGY_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '10') RARE_IMMUNOLOGY_HAIKA ON SM.SOS_CD = RARE_IMMUNOLOGY_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '11') RARE_METABOLIC_HAIKA ON SM.SOS_CD = RARE_METABOLIC_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '13') NSG2_HAIKA ON SM.SOS_CD = NSG2_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '14') RP_HAIKA ON SM.SOS_CD = RP_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '15') RD_KAMET_HAIKA ON SM.SOS_CD = RD_KAMET_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '16') RD_PDT_HAIKA ON SM.SOS_CD = RD_PDT_HAIKA.SOS_CD

       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '01') CE_HAIKA_OFFICE ON SM.SOS_CD = CE_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '02') SHIIRE_HAIKA_OFFICE ON SM.SOS_CD = SHIIRE_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '03') NSG_HAIKA_OFFICE ON SM.SOS_CD = NSG_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '04') VACCINE_HAIKA_OFFICE ON SM.SOS_CD = VACCINE_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '06') GIBU_HAIKA_OFFICE ON SM.SOS_CD = GIBU_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '07') ONC_BLOODTUMOR_HAIKA_OFFICE ON SM.SOS_CD = ONC_BLOODTUMOR_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '08') ONC_SOLIDTUMOR_HAIKA_OFFICE ON SM.SOS_CD = ONC_SOLIDTUMOR_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '09') RARE_HEMATOLOGY_HAIKA_OFFICE ON SM.SOS_CD = RARE_HEMATOLOGY_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '10') RARE_IMMUNOLOGY_HAIKA_OFFICE ON SM.SOS_CD = RARE_IMMUNOLOGY_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '11') RARE_METABOLIC_HAIKA_OFFICE ON SM.SOS_CD = RARE_METABOLIC_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '13') NSG2_HAIKA_OFFICE ON SM.SOS_CD = NSG2_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '14') RP_HAIKA_OFFICE ON SM.SOS_CD = RP_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '15') RD_KAMET_HAIKA_OFFICE ON SM.SOS_CD = RD_KAMET_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '16') RD_PDT_HAIKA_OFFICE ON SM.SOS_CD = RD_PDT_HAIKA_OFFICE.SOS_CD

       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '01') CE_HAIKA_MR ON SM.SOS_CD = CE_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '02') SHIIRE_HAIKA_MR ON SM.SOS_CD = SHIIRE_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '03') NSG_HAIKA_MR ON SM.SOS_CD = NSG_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '04') VACCINE_HAIKA_MR ON SM.SOS_CD = VACCINE_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '06') GIBU_HAIKA_MR ON SM.SOS_CD = GIBU_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '07') ONC_BLOODTUMOR_HAIKA_MR ON SM.SOS_CD = ONC_BLOODTUMOR_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '08') ONC_SOLIDTUMOR_HAIKA_MR ON SM.SOS_CD = ONC_SOLIDTUMOR_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '09') RARE_HEMATOLOGY_HAIKA_MR ON SM.SOS_CD = RARE_HEMATOLOGY_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '10') RARE_IMMUNOLOGY_HAIKA_MR ON SM.SOS_CD = RARE_IMMUNOLOGY_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '11') RARE_METABOLIC_HAIKA_MR ON SM.SOS_CD = RARE_METABOLIC_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '13') NSG2_HAIKA_MR ON SM.SOS_CD = NSG2_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '14') RP_HAIKA_MR ON SM.SOS_CD = RP_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '15') RD_KAMET_HAIKA_MR ON SM.SOS_CD = RD_KAMET_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '16') RD_PDT_HAIKA_MR ON SM.SOS_CD = RD_PDT_HAIKA_MR.SOS_CD
-->
       <!-- 行が示す組織用 -->
<!--
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '01') CE ON SM.SOS_CD = CE.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '02') SHIIRE ON SM.SOS_CD = SHIIRE.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '03') NSG ON SM.SOS_CD = NSG.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '04') VACCINE ON SM.SOS_CD = VACCINE.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '06') GIBU ON SM.SOS_CD = GIBU.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '07') ONC_BLOODTUMOR ON SM.SOS_CD = ONC_BLOODTUMOR.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '08') ONC_SOLIDTUMOR ON SM.SOS_CD = ONC_SOLIDTUMOR.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '09') RARE_HEMATOLOGY ON SM.SOS_CD = RARE_HEMATOLOGY.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '10') RARE_IMMUNOLOGY ON SM.SOS_CD = RARE_IMMUNOLOGY.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '11') RARE_METABOLIC ON SM.SOS_CD = RARE_METABOLIC.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '13') NSG2 ON SM.SOS_CD = NSG2.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '14') RP ON SM.SOS_CD = RP.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '15') RD_KAMET ON SM.SOS_CD = RD_KAMET.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '16') RD_PDT ON SM.SOS_CD = RD_PDT.SOS_CD
-->
       LEFT JOIN (SELECT * FROM HAIKA_VI) SHIIRE_HAIKA ON SM.SOS_CD = SHIIRE_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '04') VACCINE_HAIKA ON SM.SOS_CD = VACCINE_HAIKA.SOS_CD
       LEFT JOIN (SELECT SOS_CD,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT FROM HAIKA WHERE CATEGORY not in ('02','04') GROUP BY SOS_CD) JISHA_HAIKA ON SM.SOS_CD = JISHA_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '02') SHIIRE_HAIKA_OFFICE ON SM.SOS_CD = SHIIRE_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_OFFICE WHERE CATEGORY = '04') VACCINE_HAIKA_OFFICE ON SM.SOS_CD = VACCINE_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT SOS_CD,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT FROM HAIKA_OFFICE WHERE CATEGORY not in ('02','04') GROUP BY SOS_CD) JISHA_HAIKA_OFFICE ON SM.SOS_CD = JISHA_HAIKA_OFFICE.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '02') SHIIRE_HAIKA_MR ON SM.SOS_CD = SHIIRE_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '04') VACCINE_HAIKA_MR ON SM.SOS_CD = VACCINE_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT SOS_CD,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT FROM HAIKA_MR WHERE CATEGORY not in ('02','04') GROUP BY SOS_CD) JISHA_HAIKA_MR ON SM.SOS_CD = JISHA_HAIKA_MR.SOS_CD
       <!-- 行が示す組織用 -->
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '02') SHIIRE ON SM.SOS_CD = SHIIRE.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '04') VACCINE ON SM.SOS_CD = VACCINE.SOS_CD
       LEFT JOIN (SELECT SOS_CD,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT,MIN(CATEGORY) AS CATEGORY FROM SOS WHERE CATEGORY not in ('02','04') GROUP BY SOS_CD) JISHA ON SM.SOS_CD = JISHA.SOS_CD
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
</select>

<select id="shiten" resultMap="resultMap" parameterClass="java.util.Map">
WITH
SOS AS (
  SELECT
    CB.SOS_CD
    ,PP.CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_CHOSEI_BRANCH CB
      INNER JOIN DPM_C_PLANNED_PROD PP ON CB.PROD_CODE = PP.PROD_CODE
  WHERE
    PP.CAL_YEAR = '$calYear$'
    AND PP.CAL_TERM = '$calTerm.dbValue$'
    AND CB.CAL_YEAR = '$calYear$'
    AND CB.CAL_TERM = '$calTerm.dbValue$'
    AND CB.CHOSEI_2_VALUE_Y != 0
    AND CB.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CB.DEL_FLG = '0'
  GROUP BY
    CB.SOS_CD, PP.CATEGORY
),
SOS_VI AS (
  SELECT
    CB.SOS_CD
    ,'2' AS CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_VI_CHOSEI_BRANCH CB
  WHERE
    CB.CAL_YEAR = '$calYear$'
    AND CB.CAL_TERM = '$calTerm.dbValue$'
    AND CB.CHOSEI_2_VALUE_Y != 0
    AND CB.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CB.DEL_FLG = '0'
  GROUP BY
      SOS_CD
),
HAIKA AS (
  SELECT
    SM.UP_SOS_CD AS SOS_CD
    ,PP.CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_CHOSEI_OFFICE CO
      INNER JOIN DPM_C_VI_SOS_MST SM ON CO.SOS_CD = SM.SOS_CD
        INNER JOIN DPM_C_PLANNED_PROD PP ON CO.PROD_CODE = PP.PROD_CODE
  WHERE
    SM.BUMON_RANK = 3
    AND PP.CAL_YEAR = '$calYear$'
    AND PP.CAL_TERM = '$calTerm.dbValue$'
    AND CO.CAL_YEAR = '$calYear$'
    AND CO.CAL_TERM = '$calTerm.dbValue$'
    AND CO.CHOSEI_2_VALUE_Y != 0
    AND CO.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CO.DEL_FLG = '0'
  GROUP BY
    SM.UP_SOS_CD, PP.CATEGORY
),
HAIKA_MR AS (
  SELECT
    JM.SOS_CD2 AS SOS_CD
    ,PP.CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_CHOSEI_MR CM
      INNER JOIN DPM_C_VI_JGI_MST JM ON CM.JGI_NO = JM.JGI_NO
        INNER JOIN DPM_C_PLANNED_PROD PP ON CM.PROD_CODE = PP.PROD_CODE
  WHERE
    PP.CAL_YEAR = '$calYear$'
    AND PP.CAL_TERM = '$calTerm.dbValue$'
    AND CM.CAL_YEAR = '$calYear$'
    AND CM.CAL_TERM = '$calTerm.dbValue$'
    AND CM.CHOSEI_2_VALUE_Y != 0
    AND CM.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CM.DEL_FLG = '0'
  GROUP BY
    JM.SOS_CD2, PP.CATEGORY
)
SELECT
  SM.SOS_CD
  ,NULL AS JGI_NO
  ,SM.BUMON_SEI_NAME AS SOS_JGI_NAME
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
  <!--  配下組織の調整計画 自社（MMP）・・・ 営業所、NSG,CV,SPBU,血液腫瘍、固形腫瘍、レア系 -->
<!--
  ,CASE
     WHEN CE_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN CE_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN GIBU_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN GIBU_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
-->
  <!--  配下組織の調整計画 自社（MMP）・・・ 仕入、ワクチン以外 -->
  ,CASE
     WHEN JISHA_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN JISHA_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->

     ELSE '0'
  END AS MMP_HAIKA_CHOSEI_FLG
  <!--  配下組織の調整計画 仕入品 -->
  ,CASE
     WHEN SHIIRE_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN SHIIRE_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS SHIIRE_HAIKA_CHOSEI_FLG
  <!--  配下組織の調整計画 ワクチン品 -->
  ,CASE
     WHEN VACCINE_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN VACCINE_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS VACCINE_HAIKA_CHOSEI_FLG
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
  <!--  調整計画 自社（MMP）・・・ 営業所、NSG,CV,SPBU,血液腫瘍、固形腫瘍、レア系 -->
<!--
  ,CASE
     WHEN CE.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG.CHOSEI_COUNT > 0 THEN '1'
     WHEN GIBU.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT .CHOSEI_COUNT > 0 THEN '1'
-->
  <!--  調整計画 自社（MMP）・・・ 仕入、ワクチン以外 -->
  ,CASE
     WHEN JISHA.CHOSEI_COUNT > 0 THEN '1'
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
     ELSE '0'
     END AS MMP_CHOSEI_FLG
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
<!--
  ,CASE
     WHEN CE.CHOSEI_COUNT > 0 THEN CE.CATEGORY
     WHEN NSG.CHOSEI_COUNT > 0 THEN NSG.CATEGORY
     WHEN GIBU.CHOSEI_COUNT > 0 THEN GIBU.CATEGORY
     WHEN ONC_BLOODTUMOR.CHOSEI_COUNT > 0 THEN ONC_BLOODTUMOR.CATEGORY
     WHEN ONC_SOLIDTUMOR.CHOSEI_COUNT > 0 THEN ONC_SOLIDTUMOR.CATEGORY
     WHEN RARE_HEMATOLOGY.CHOSEI_COUNT > 0 THEN RARE_HEMATOLOGY.CATEGORY
     WHEN RARE_IMMUNOLOGY.CHOSEI_COUNT > 0 THEN RARE_IMMUNOLOGY.CATEGORY
     WHEN RARE_METABOLIC.CHOSEI_COUNT > 0 THEN RARE_METABOLIC.CATEGORY
     WHEN NSG2.CHOSEI_COUNT > 0 THEN NSG2.CATEGORY
     WHEN RP.CHOSEI_COUNT > 0 THEN RP.CATEGORY
     WHEN RD_KAMET.CHOSEI_COUNT > 0 THEN RD_KAMET.CATEGORY
     WHEN RD_PDT .CHOSEI_COUNT > 0 THEN RD_PDT .CATEGORY
-->
  ,CASE
     WHEN JISHA.CHOSEI_COUNT > 0 THEN JISHA.CATEGORY
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
     ELSE '--'
  END AS MMP_CHOSEI_CATE_PICKEDUP
  <!-- 調整計画 仕入品 -->
  ,CASE
     WHEN SHIIRE.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS SHIIRE_CHOSEI_FLG
  ,CASE
     WHEN SHIIRE.CHOSEI_COUNT > 0 THEN SHIIRE.CATEGORY
     ELSE '--'
  END AS SHIIRE_CHOSEI_CATE_PICKEDUP
  <!-- 調整計画 ワクチン -->
  ,CASE
     WHEN VACCINE.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS VACCINE_CHOSEI_FLG
  ,CASE
     WHEN VACCINE.CHOSEI_COUNT > 0 THEN VACCINE.CATEGORY
     ELSE '--'
  END AS VACCINE_CHOSEI_CATE_PICKEDUP
  <!--  オンコロジー組織フラグ -->
  ,SM.ONC_SOS_FLG
FROM
   DPM_C_VI_SOS_MST SM
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
<!--
     LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '01') CE_HAIKA ON SM.SOS_CD = CE_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '02') SHIIRE_HAIKA ON SM.SOS_CD = SHIIRE_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '03') NSG_HAIKA ON SM.SOS_CD = NSG_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '04') VACCINE_HAIKA ON SM.SOS_CD = VACCINE_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '06') GIBU_HAIKA ON SM.SOS_CD = GIBU_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '07') ONC_BLOODTUMOR_HAIKA ON SM.SOS_CD = ONC_BLOODTUMOR_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '08') ONC_SOLIDTUMOR_HAIKA ON SM.SOS_CD = ONC_SOLIDTUMOR_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '09') RARE_HEMATOLOGY_HAIKA ON SM.SOS_CD = RARE_HEMATOLOGY_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '10') RARE_IMMUNOLOGY_HAIKA ON SM.SOS_CD = RARE_IMMUNOLOGY_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '11') RARE_METABOLIC_HAIKA ON SM.SOS_CD = RARE_METABOLIC_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '13') NSG2_HAIKA ON SM.SOS_CD = NSG2_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '14') RP_HAIKA ON SM.SOS_CD = RP_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '15') RD_KAMET_HAIKA ON SM.SOS_CD = RD_KAMET_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '16') RD_PDT_HAIKA ON SM.SOS_CD = RD_PDT_HAIKA.SOS_CD


       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '01') CE_HAIKA_MR ON SM.SOS_CD = CE_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '02') SHIIRE_HAIKA_MR ON SM.SOS_CD = SHIIRE_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '03') NSG_HAIKA_MR ON SM.SOS_CD = NSG_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '04') VACCINE_HAIKA_MR ON SM.SOS_CD = VACCINE_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '06') GIBU_HAIKA_MR ON SM.SOS_CD = GIBU_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '07') ONC_BLOODTUMOR_HAIKA_MR ON SM.SOS_CD = ONC_BLOODTUMOR_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '08') ONC_SOLIDTUMOR_HAIKA_MR ON SM.SOS_CD = ONC_SOLIDTUMOR_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '09') RARE_HEMATOLOGY_HAIKA_MR ON SM.SOS_CD = RARE_HEMATOLOGY_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '10') RARE_IMMUNOLOGY_HAIKA_MR ON SM.SOS_CD = RARE_IMMUNOLOGY_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '11') RARE_METABOLIC_HAIKA_MR ON SM.SOS_CD = RARE_METABOLIC_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '13') NSG2_HAIKA_MR ON SM.SOS_CD = NSG2_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '14') RP_HAIKA_MR ON SM.SOS_CD = RP_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '15') RD_KAMET_HAIKA_MR ON SM.SOS_CD = RD_KAMET_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '16') RD_PDT_HAIKA_MR ON SM.SOS_CD = RD_PDT_HAIKA_MR.SOS_CD
-->
       <!-- 行が示す組織用 -->
<!--
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '01') CE ON SM.SOS_CD = CE.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '02') SHIIRE ON SM.SOS_CD = SHIIRE.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '03') NSG ON SM.SOS_CD = NSG.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '04') VACCINE ON SM.SOS_CD = VACCINE.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '06') GIBU ON SM.SOS_CD = GIBU.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '07') ONC_BLOODTUMOR ON SM.SOS_CD = ONC_BLOODTUMOR.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '08') ONC_SOLIDTUMOR ON SM.SOS_CD = ONC_SOLIDTUMOR.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '09') RARE_HEMATOLOGY ON SM.SOS_CD = RARE_HEMATOLOGY.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '10') RARE_IMMUNOLOGY ON SM.SOS_CD = RARE_IMMUNOLOGY.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '11') RARE_METABOLIC ON SM.SOS_CD = RARE_METABOLIC.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '13') NSG2 ON SM.SOS_CD = NSG2.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '14') RP ON SM.SOS_CD = RP.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '15') RD_KAMET ON SM.SOS_CD = RD_KAMET.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '16') RD_PDT ON SM.SOS_CD = RD_PDT.SOS_CD
-->
     LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '02') SHIIRE_HAIKA ON SM.SOS_CD = SHIIRE_HAIKA.SOS_CD
     LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '04') VACCINE_HAIKA ON SM.SOS_CD = VACCINE_HAIKA.SOS_CD
     LEFT JOIN (SELECT SOS_CD,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT FROM HAIKA WHERE CATEGORY not in ('02','04') GROUP BY SOS_CD) JISHA_HAIKA ON SM.SOS_CD = JISHA_HAIKA.SOS_CD
     LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '02') SHIIRE_HAIKA_MR ON SM.SOS_CD = SHIIRE_HAIKA_MR.SOS_CD
     LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '04') VACCINE_HAIKA_MR ON SM.SOS_CD = VACCINE_HAIKA_MR.SOS_CD
     LEFT JOIN (SELECT SOS_CD,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT FROM HAIKA_MR WHERE CATEGORY not in ('02','04') GROUP BY SOS_CD) JISHA_HAIKA_MR ON SM.SOS_CD = JISHA_HAIKA_MR.SOS_CD
     <!-- 行が示す組織用 -->
     LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '02') SHIIRE ON SM.SOS_CD = SHIIRE.SOS_CD
     LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '04') VACCINE ON SM.SOS_CD = VACCINE.SOS_CD
     LEFT JOIN (SELECT SOS_CD,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT,MIN(CATEGORY) AS CATEGORY FROM SOS WHERE CATEGORY not in ('02','04') GROUP BY SOS_CD) JISHA ON SM.SOS_CD = JISHA.SOS_CD
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
WHERE
  SM.BUMON_RANK = 2
  AND EXISTS (SELECT SOS_CD FROM DPS_S_SY_M_SOS_GRP_M WHERE SOS_CD = SM.SOS_CD AND SOS_GROP = #shiten:VARCHAR#)
ORDER BY
  BR_CODE, DIST_CODE, DIST_SEQ, TEAM_CODE
</select>

<select id="office" resultMap="resultMap" parameterClass="java.util.Map">
WITH
SOS AS (
  SELECT
    CO.SOS_CD
    ,PP.CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_CHOSEI_OFFICE CO
      INNER JOIN DPM_C_PLANNED_PROD PP ON CO.PROD_CODE = PP.PROD_CODE
  WHERE
    PP.CAL_YEAR = '$calYear$'
    AND PP.CAL_TERM = '$calTerm.dbValue$'
    AND CO.CAL_YEAR = '$calYear$'
    AND CO.CAL_TERM = '$calTerm.dbValue$'
    AND CO.CHOSEI_2_VALUE_Y != 0
    AND CO.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CO.DEL_FLG = '0'
  GROUP BY
    CO.SOS_CD, PP.CATEGORY
),
HAIKA AS (
  SELECT
    SM.UP_SOS_CD AS SOS_CD
    ,PP.CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_CHOSEI_TEAM CT
      INNER JOIN DPM_C_VI_SOS_MST SM ON CT.SOS_CD = SM.SOS_CD AND CT.ETC_SOS_FLG = SM.ETC_SOS_FLG
        INNER JOIN DPM_C_PLANNED_PROD PP ON CT.PROD_CODE = PP.PROD_CODE
  WHERE
    SM.BUMON_RANK = 4
    AND PP.CAL_YEAR = '$calYear$'
    AND PP.CAL_TERM = '$calTerm.dbValue$'
    AND CT.CAL_YEAR = '$calYear$'
    AND CT.CAL_TERM = '$calTerm.dbValue$'
    AND CT.CHOSEI_2_VALUE_Y != 0
    AND CT.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CT.DEL_FLG = '0'
  GROUP BY
    SM.UP_SOS_CD, PP.CATEGORY
),
HAIKA_MR AS (
  SELECT
    JM.SOS_CD3 AS SOS_CD
    ,PP.CATEGORY
    ,COUNT(*) AS CHOSEI_COUNT
  FROM
    DPM_I_CHOSEI_MR CM
      INNER JOIN DPM_C_VI_JGI_MST JM ON CM.JGI_NO = JM.JGI_NO
        INNER JOIN DPM_C_PLANNED_PROD PP ON CM.PROD_CODE = PP.PROD_CODE
  WHERE
    PP.CAL_YEAR = '$calYear$'
    AND PP.CAL_TERM = '$calTerm.dbValue$'
    AND CM.CAL_YEAR = '$calYear$'
    AND CM.CAL_TERM = '$calTerm.dbValue$'
    AND CM.CHOSEI_2_VALUE_Y != 0
    AND CM.CHOSEI_2_VALUE_Y IS NOT NULL
    AND CM.DEL_FLG = '0'
  GROUP BY
    JM.SOS_CD3, PP.CATEGORY
)
SELECT
  SM.SOS_CD
  ,NULL AS JGI_NO
  ,SM.BUMON_SEI_NAME AS SOS_JGI_NAME
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
  <!--  配下組織の調整計画 自社（MMP）・・・ 営業所、NSG,CV,SPBU,血液腫瘍、固形腫瘍、レア系 -->
<!--
  ,CASE
     WHEN CE_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN CE_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN GIBU_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN GIBU_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
-->
  <!--  配下組織の調整計画 自社（MMP）・・・ 仕入、ワクチン以外 -->
  ,CASE
     WHEN JISHA_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN JISHA_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
     ELSE '0'
  END AS MMP_HAIKA_CHOSEI_FLG
  <!--  配下組織の調整計画 仕入品 -->
  ,CASE
     WHEN SHIIRE_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN SHIIRE_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS SHIIRE_HAIKA_CHOSEI_FLG
  <!--  配下組織の調整計画 ワクチン品 -->
  ,CASE
     WHEN VACCINE_HAIKA.CHOSEI_COUNT > 0 THEN '1'
     WHEN VACCINE_HAIKA_MR.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS VACCINE_HAIKA_CHOSEI_FLG
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
  <!--  調整計画 自社（MMP）・・・ 営業所、NSG,CV,SPBU,血液腫瘍、固形腫瘍、レア系 -->
<!--
  ,CASE
     WHEN CE.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG.CHOSEI_COUNT > 0 THEN '1'
     WHEN GIBU.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT .CHOSEI_COUNT > 0 THEN '1'
-->
  <!--  調整計画 自社（MMP）・・・ 仕入、ワクチン以外 -->
  ,CASE
     WHEN JISHA.CHOSEI_COUNT > 0 THEN '1'
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
     ELSE '0'
  END AS MMP_CHOSEI_FLG
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
<!--
  ,CASE
     WHEN CE.CHOSEI_COUNT > 0 THEN CE.CATEGORY
     WHEN NSG.CHOSEI_COUNT > 0 THEN NSG.CATEGORY
     WHEN GIBU.CHOSEI_COUNT > 0 THEN GIBU.CATEGORY
     WHEN ONC_BLOODTUMOR.CHOSEI_COUNT > 0 THEN ONC_BLOODTUMOR.CATEGORY
     WHEN ONC_SOLIDTUMOR.CHOSEI_COUNT > 0 THEN ONC_SOLIDTUMOR.CATEGORY
     WHEN RARE_HEMATOLOGY.CHOSEI_COUNT > 0 THEN RARE_HEMATOLOGY.CATEGORY
     WHEN RARE_IMMUNOLOGY.CHOSEI_COUNT > 0 THEN RARE_IMMUNOLOGY.CATEGORY
     WHEN RARE_METABOLIC.CHOSEI_COUNT > 0 THEN RARE_METABOLIC.CATEGORY
     WHEN NSG2.CHOSEI_COUNT > 0 THEN NSG2.CATEGORY
     WHEN RP.CHOSEI_COUNT > 0 THEN RP.CATEGORY
     WHEN RD_KAMET.CHOSEI_COUNT > 0 THEN RD_KAMET.CATEGORY
     WHEN RD_PDT .CHOSEI_COUNT > 0 THEN RD_PDT .CATEGORY
-->
  ,CASE
     WHEN JISHA.CHOSEI_COUNT > 0 THEN JISHA.CATEGORY
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
     ELSE '--'
  END AS MMP_CHOSEI_CATE_PICKEDUP
  <!-- 調整計画 仕入品 -->
  ,CASE
     WHEN SHIIRE.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS SHIIRE_CHOSEI_FLG
  ,CASE
     WHEN SHIIRE.CHOSEI_COUNT > 0 THEN SHIIRE.CATEGORY
     ELSE '--'
  END AS SHIIRE_CHOSEI_CATE_PICKEDUP
  <!-- 調整計画 ワクチン -->
  ,CASE
     WHEN VACCINE.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS VACCINE_CHOSEI_FLG
  ,CASE
     WHEN VACCINE.CHOSEI_COUNT > 0 THEN VACCINE.CATEGORY
     ELSE '--'
  END AS VACCINE_CHOSEI_CATE_PICKEDUP
  <!--  オンコロジー組織フラグ -->
  ,SM.ONC_SOS_FLG
FROM
  DPM_C_VI_SOS_MST SM
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
<!--
    LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '01') CE_HAIKA ON SM.SOS_CD = CE_HAIKA.SOS_CD
      LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '02') SHIIRE_HAIKA ON SM.SOS_CD = SHIIRE_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '03') NSG_HAIKA ON SM.SOS_CD = NSG_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '04') VACCINE_HAIKA ON SM.SOS_CD = VACCINE_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '06') GIBU_HAIKA ON SM.SOS_CD = GIBU_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '07') ONC_BLOODTUMOR_HAIKA ON SM.SOS_CD = ONC_BLOODTUMOR_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '08') ONC_SOLIDTUMOR_HAIKA ON SM.SOS_CD = ONC_SOLIDTUMOR_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '09') RARE_HEMATOLOGY_HAIKA ON SM.SOS_CD = RARE_HEMATOLOGY_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '10') RARE_IMMUNOLOGY_HAIKA ON SM.SOS_CD = RARE_IMMUNOLOGY_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '11') RARE_METABOLIC_HAIKA ON SM.SOS_CD = RARE_METABOLIC_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '13') NSG2_HAIKA ON SM.SOS_CD = NSG2_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '14') RP_HAIKA ON SM.SOS_CD = RP_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '15') RD_KAMET_HAIKA ON SM.SOS_CD = RD_KAMET_HAIKA.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '16') RD_PDT_HAIKA ON SM.SOS_CD = RD_PDT_HAIKA.SOS_CD


        LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '01') CE_HAIKA_MR ON SM.SOS_CD = CE_HAIKA_MR.SOS_CD
          LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '02') SHIIRE_HAIKA_MR ON SM.SOS_CD = SHIIRE_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '03') NSG_HAIKA_MR ON SM.SOS_CD = NSG_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '04') VACCINE_HAIKA_MR ON SM.SOS_CD = VACCINE_HAIKA_MR.SOS_CD
          LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '06') GIBU_HAIKA_MR ON SM.SOS_CD = GIBU_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '07') ONC_BLOODTUMOR_HAIKA_MR ON SM.SOS_CD = ONC_BLOODTUMOR_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '08') ONC_SOLIDTUMOR_HAIKA_MR ON SM.SOS_CD = ONC_SOLIDTUMOR_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '09') RARE_HEMATOLOGY_HAIKA_MR ON SM.SOS_CD = RARE_HEMATOLOGY_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '10') RARE_IMMUNOLOGY_HAIKA_MR ON SM.SOS_CD = RARE_IMMUNOLOGY_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '11') RARE_METABOLIC_HAIKA_MR ON SM.SOS_CD = RARE_METABOLIC_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '13') NSG2_HAIKA_MR ON SM.SOS_CD = NSG2_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '14') RP_HAIKA_MR ON SM.SOS_CD = RP_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '15') RD_KAMET_HAIKA_MR ON SM.SOS_CD = RD_KAMET_HAIKA_MR.SOS_CD
       LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '16') RD_PDT_HAIKA_MR ON SM.SOS_CD = RD_PDT_HAIKA_MR.SOS_CD
-->
       <!-- 行が示す組織用 -->
<!--
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '01') CE ON SM.SOS_CD = CE.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '02') SHIIRE ON SM.SOS_CD = SHIIRE.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '03') NSG ON SM.SOS_CD = NSG.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '04') VACCINE ON SM.SOS_CD = VACCINE.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '06') GIBU ON SM.SOS_CD = GIBU.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '07') ONC_BLOODTUMOR ON SM.SOS_CD = ONC_BLOODTUMOR.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '08') ONC_SOLIDTUMOR ON SM.SOS_CD = ONC_SOLIDTUMOR.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '09') RARE_HEMATOLOGY ON SM.SOS_CD = RARE_HEMATOLOGY.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '10') RARE_IMMUNOLOGY ON SM.SOS_CD = RARE_IMMUNOLOGY.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '11') RARE_METABOLIC ON SM.SOS_CD = RARE_METABOLIC.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '13') NSG2 ON SM.SOS_CD = NSG2.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '14') RP ON SM.SOS_CD = RP.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '15') RD_KAMET ON SM.SOS_CD = RD_KAMET.SOS_CD
       LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '16') RD_PDT ON SM.SOS_CD = RD_PDT.SOS_CD
-->
    LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '02') SHIIRE_HAIKA ON SM.SOS_CD = SHIIRE_HAIKA.SOS_CD
    LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '04') VACCINE_HAIKA ON SM.SOS_CD = VACCINE_HAIKA.SOS_CD
    LEFT JOIN (SELECT SOS_CD,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT FROM HAIKA WHERE CATEGORY not in ('02','04') GROUP BY SOS_CD) JISHA_HAIKA ON SM.SOS_CD = JISHA_HAIKA.SOS_CD
    LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '02') SHIIRE_HAIKA_MR ON SM.SOS_CD = SHIIRE_HAIKA_MR.SOS_CD
    LEFT JOIN (SELECT * FROM HAIKA_MR WHERE CATEGORY = '04') VACCINE_HAIKA_MR ON SM.SOS_CD = VACCINE_HAIKA_MR.SOS_CD
    LEFT JOIN (SELECT SOS_CD,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT FROM HAIKA_MR WHERE CATEGORY not in ('02','04') GROUP BY SOS_CD) JISHA_HAIKA_MR ON SM.SOS_CD = JISHA_HAIKA_MR.SOS_CD
    <!-- 行が示す組織用 -->
    LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '02') SHIIRE ON SM.SOS_CD = SHIIRE.SOS_CD
    LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '04') VACCINE ON SM.SOS_CD = VACCINE.SOS_CD
    LEFT JOIN (SELECT SOS_CD,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT,MIN(CATEGORY) AS CATEGORY FROM SOS WHERE CATEGORY not in ('02','04') GROUP BY SOS_CD) JISHA ON SM.SOS_CD = JISHA.SOS_CD
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
WHERE
  SM.BUMON_RANK = 3
  AND EXISTS (SELECT SOS_CD FROM DPS_S_SY_M_SOS_GRP_M WHERE SOS_CD = SM.SOS_CD AND SOS_GROP = #shiten:VARCHAR#)
  AND SM.UP_SOS_CD = #sosCd2:VARCHAR#
ORDER BY
  BR_CODE, DIST_CODE, DIST_SEQ, TEAM_CODE
</select>

<!-- <select id="team" resultMap="resultMap" parameterClass="java.util.Map"> -->
<!-- WITH -->
<!-- SOS AS ( -->
<!--   SELECT -->
<!--     CT.SOS_CD -->
<!--     ,PP.CATEGORY -->
<!--     ,COUNT(*) AS CHOSEI_COUNT -->
<!--   FROM -->
<!--     DPM_I_CHOSEI_TEAM CT -->
<!--       INNER JOIN DPM_C_PLANNED_PROD PP ON CT.PROD_CODE = PP.PROD_CODE -->
<!--   WHERE -->
<!--     PP.CAL_YEAR = '$calYear$' -->
<!--     AND PP.CAL_TERM = '$calTerm.dbValue$' -->
<!--     AND CT.CAL_YEAR = '$calYear$' -->
<!--     AND CT.CAL_TERM = '$calTerm.dbValue$' -->
<!--     AND CT.CHOSEI_2_VALUE_Y != 0 -->
<!--     AND CT.CHOSEI_2_VALUE_Y IS NOT NULL -->
<!--     AND CT.DEL_FLG = '0' -->
<!--   GROUP BY -->
<!--     CT.SOS_CD, PP.CATEGORY -->
<!-- ), -->
<!-- HAIKA AS ( -->
<!--   SELECT -->
<!--     JM.SOS_CD AS SOS_CD -->
<!--     ,PP.CATEGORY -->
<!--     ,COUNT(*) AS CHOSEI_COUNT -->
<!--   FROM -->
<!--     DPM_I_CHOSEI_MR CM -->
<!--       INNER JOIN DPM_C_VI_JGI_MST JM ON CM.JGI_NO = JM.JGI_NO -->
<!--         INNER JOIN DPM_C_PLANNED_PROD PP ON CM.PROD_CODE = PP.PROD_CODE -->
<!--   WHERE -->
<!--     PP.CAL_YEAR = '$calYear$' -->
<!--     AND PP.CAL_TERM = '$calTerm.dbValue$' -->
<!--     AND CM.CAL_YEAR = '$calYear$' -->
<!--     AND CM.CAL_TERM = '$calTerm.dbValue$' -->
<!--     AND CM.CHOSEI_2_VALUE_Y != 0 -->
<!--     AND CM.CHOSEI_2_VALUE_Y IS NOT NULL -->
<!--     AND CM.DEL_FLG = '0' -->
<!--   GROUP BY -->
<!--     JM.SOS_CD, PP.CATEGORY -->
<!-- ) -->
<!-- SELECT -->
<!--   SM.SOS_CD -->
<!--   ,NULL AS JGI_NO -->
<!--   ,SM.BUMON_SEI_NAME AS SOS_JGI_NAME -->
<!--   ,CASE -->
<!--      WHEN MMP_HAIKA.CHOSEI_COUNT > 0 THEN '1' -->
<!--      WHEN ONC_HAIKA.CHOSEI_COUNT > 0 THEN '1' -->
<!--      WHEN SPBU_HAIKA.CHOSEI_COUNT > 0 THEN '1' -->
<!--      ELSE '0' -->
<!--   END AS MMP_HAIKA_CHOSEI_FLG -->
<!--   ,CASE -->
<!--      WHEN SHIIRE_HAIKA.CHOSEI_COUNT > 0 THEN '1' -->
<!--      ELSE '0' -->
<!--   END AS SHIIRE_HAIKA_CHOSEI_FLG -->
<!--   ,CASE -->
<!--     WHEN MMP.CHOSEI_COUNT > 0 THEN '1' -->
<!--     WHEN ONC.CHOSEI_COUNT > 0 THEN '1' -->
<!--     WHEN SPBU.CHOSEI_COUNT > 0 THEN '1' -->
<!--     ELSE '0' -->
<!--   END AS MMP_CHOSEI_FLG -->
<!--   ,CASE -->
<!--     WHEN SHIIRE.CHOSEI_COUNT > 0 THEN '1' -->
<!--     ELSE '0' -->
<!--   END AS SHIIRE_CHOSEI_FLG -->
<!--   ,SM.ONC_SOS_FLG -->
<!-- FROM -->
<!--   DPM_C_VI_SOS_MST SM -->
<!--     LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '1') MMP_HAIKA ON SM.SOS_CD = MMP_HAIKA.SOS_CD -->
<!--       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '2') SHIIRE_HAIKA ON SM.SOS_CD = SHIIRE_HAIKA.SOS_CD -->
<!--       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '3') ONC_HAIKA ON SM.SOS_CD = ONC_HAIKA.SOS_CD -->
<!--       LEFT JOIN (SELECT * FROM HAIKA WHERE CATEGORY = '4') SPBU_HAIKA ON SM.SOS_CD = SPBU_HAIKA.SOS_CD -->
<!--         LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '1') MMP ON SM.SOS_CD = MMP.SOS_CD -->
<!--           LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '2') SHIIRE ON SM.SOS_CD = SHIIRE.SOS_CD -->
<!--           LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '3') ONC ON SM.SOS_CD = ONC.SOS_CD -->
<!--           LEFT JOIN (SELECT * FROM SOS WHERE CATEGORY = '4') SPBU ON SM.SOS_CD = SPBU.SOS_CD -->
<!-- HERE -->
<!--   SM.BUMON_RANK = 4 -->
<!--   AND EXISTS (SELECT SOS_CD FROM DPS_S_SY_M_SOS_GRP_M WHERE SOS_CD = SM.SOS_CD AND SOS_GROP = #shiten:VARCHAR#) -->
<!--   AND NOT EXISTS (SELECT SOS_CD FROM DPS_S_SY_M_SOS_GRP_M WHERE SOS_CD = SM.SOS_CD AND SOS_GROP = #seikei_mr:VARCHAR#) -->
<!--   AND SM.UP_SOS_CD = #sosCd3:VARCHAR# -->
<!-- ORDER BY -->
<!--   BR_CODE, DIST_CODE, DIST_SEQ, TEAM_CODE -->
<!-- </select> -->

<select id="mr" resultMap="resultMap" parameterClass="java.util.Map">
    WITH JGI AS (
    SELECT
      CM.JGI_NO
      ,PP.CATEGORY
      ,COUNT(*) AS CHOSEI_COUNT
    FROM
      DPM_I_CHOSEI_MR CM
        INNER JOIN DPM_C_PLANNED_PROD PP ON CM.PROD_CODE = PP.PROD_CODE
    WHERE
      PP.CAL_YEAR = '$calYear$'
      AND PP.CAL_TERM = '$calTerm.dbValue$'
      AND CM.CAL_YEAR = '$calYear$'
      AND CM.CAL_TERM = '$calTerm.dbValue$'
      AND CM.CHOSEI_2_VALUE_Y != 0
      AND CM.CHOSEI_2_VALUE_Y IS NOT NULL
      AND CM.DEL_FLG = '0'
    GROUP BY
    CM.JGI_NO, PP.CATEGORY
    )
    SELECT
      NULL AS SOS_CD
      ,JM.JGI_NO
      ,JM.JGI_NAME AS SOS_JGI_NAME
      ,'0' AS MMP_HAIKA_CHOSEI_FLG
      ,'0' AS SHIIRE_HAIKA_CHOSEI_FLG
      ,'0' AS VACCINE_HAIKA_CHOSEI_FLG
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
  <!--  調整計画 自社（MMP）・・・ 営業所、NSG,CV,SPBU,血液腫瘍、固形腫瘍、レア系 -->
<!--
      ,CASE
        WHEN CE.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG.CHOSEI_COUNT > 0 THEN '1'
        WHEN GIBU.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_BLOODTUMOR.CHOSEI_COUNT > 0 THEN '1'
     WHEN ONC_SOLIDTUMOR.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_HEMATOLOGY.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_IMMUNOLOGY.CHOSEI_COUNT > 0 THEN '1'
     WHEN RARE_METABOLIC.CHOSEI_COUNT > 0 THEN '1'
     WHEN NSG2.CHOSEI_COUNT > 0 THEN '1'
     WHEN RP.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_KAMET.CHOSEI_COUNT > 0 THEN '1'
     WHEN RD_PDT .CHOSEI_COUNT > 0 THEN '1'
-->
  <!--  調整計画 自社（MMP）・・・ 仕入、ワクチン以外 -->
      ,CASE
        WHEN JISHA.CHOSEI_COUNT > 0 THEN '1'
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
        ELSE '0'
      END AS MMP_CHOSEI_FLG
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
<!--
      ,CASE
     WHEN CE.CHOSEI_COUNT > 0 THEN CE.CATEGORY
     WHEN NSG.CHOSEI_COUNT > 0 THEN NSG.CATEGORY
     WHEN GIBU.CHOSEI_COUNT > 0 THEN GIBU.CATEGORY
     WHEN ONC_BLOODTUMOR.CHOSEI_COUNT > 0 THEN ONC_BLOODTUMOR.CATEGORY
     WHEN ONC_SOLIDTUMOR.CHOSEI_COUNT > 0 THEN ONC_SOLIDTUMOR.CATEGORY
     WHEN RARE_HEMATOLOGY.CHOSEI_COUNT > 0 THEN RARE_HEMATOLOGY.CATEGORY
     WHEN RARE_IMMUNOLOGY.CHOSEI_COUNT > 0 THEN RARE_IMMUNOLOGY.CATEGORY
     WHEN RARE_METABOLIC.CHOSEI_COUNT > 0 THEN RARE_METABOLIC.CATEGORY
     WHEN NSG2.CHOSEI_COUNT > 0 THEN NSG2.CATEGORY
     WHEN RP.CHOSEI_COUNT > 0 THEN RP.CATEGORY
     WHEN RD_KAMET.CHOSEI_COUNT > 0 THEN RD_KAMET.CATEGORY
     WHEN RD_PDT .CHOSEI_COUNT > 0 THEN RD_PDT .CATEGORY
-->
      ,CASE
        WHEN JISHA.CHOSEI_COUNT > 0 THEN JISHA.CATEGORY
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
     ELSE '--'
  END AS MMP_CHOSEI_CATE_PICKEDUP
  <!-- 調整計画 仕入品 -->
  ,CASE
        WHEN SHIIRE.CHOSEI_COUNT > 0 THEN '1'
        ELSE '0'
      END AS SHIIRE_CHOSEI_FLG
  ,CASE
     WHEN SHIIRE.CHOSEI_COUNT > 0 THEN SHIIRE.CATEGORY
     ELSE '--'
  END AS SHIIRE_CHOSEI_CATE_PICKEDUP
  <!-- 調整計画 ワクチン -->
  ,CASE
     WHEN VACCINE.CHOSEI_COUNT > 0 THEN '1'
     ELSE '0'
  END AS VACCINE_CHOSEI_FLG
  ,CASE
     WHEN VACCINE.CHOSEI_COUNT > 0 THEN VACCINE.CATEGORY
     ELSE '--'
  END AS VACCINE_CHOSEI_CATE_PICKEDUP
  <!--  オンコロジー組織フラグ -->
     ,SM.ONC_SOS_FLG
    FROM
      DPM_C_VI_JGI_MST JM
      INNER JOIN DPM_C_VI_SOS_MST SM ON JM.SOS_CD = SM.SOS_CD AND SM.ETC_SOS_FLG = JM.ETC_SOS_FLG
<!-- mod Start 2025/04/07 H.Futagami 組織変更対応 -->
<!--
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '01') CE ON JM.JGI_NO = CE.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '02') SHIIRE ON JM.JGI_NO = SHIIRE.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '03') NSG ON JM.JGI_NO = NSG.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '04') VACCINE ON JM.JGI_NO = VACCINE.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '06') GIBU ON JM.JGI_NO = GIBU.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '07') ONC_BLOODTUMOR ON JM.JGI_NO = ONC_BLOODTUMOR.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '08') ONC_SOLIDTUMOR ON JM.JGI_NO = ONC_SOLIDTUMOR.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '09') RARE_HEMATOLOGY ON JM.JGI_NO = RARE_HEMATOLOGY.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '10') RARE_IMMUNOLOGY ON JM.JGI_NO = RARE_IMMUNOLOGY.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '11') RARE_METABOLIC ON JM.JGI_NO = RARE_METABOLIC.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '13') NSG2 ON JM.JGI_NO = NSG2.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '14') RP ON JM.JGI_NO = RP.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '15') RD_KAMET ON JM.JGI_NO = RD_KAMET.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '16') RD_PDT ON JM.JGI_NO = RD_PDT.JGI_NO
-->
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '02') SHIIRE ON JM.JGI_NO = SHIIRE.JGI_NO
       LEFT JOIN (SELECT * FROM JGI WHERE CATEGORY = '04') VACCINE ON JM.JGI_NO = VACCINE.JGI_NO
       LEFT JOIN (SELECT JGI_NO,SUM(CHOSEI_COUNT) AS CHOSEI_COUNT,MIN(CATEGORY) AS CATEGORY FROM JGI WHERE CATEGORY not in ('02','04') GROUP BY JGI_NO) JISHA ON JM.JGI_NO = JISHA.JGI_NO
<!-- mod End 2025/04/07 H.Futagami 組織変更対応 -->
    WHERE
      JM.SOS_CD = #sosCd:VARCHAR#
       <isNotNull property="jgiKbList">
           <iterate prepend="AND JM.JGI_KB IN" open="(" close=")" conjunction=","  property="jgiKbList">
               #jgiKbList[].dbValue#
           </iterate>
       </isNotNull>
      <isNotNull prepend="AND" property="jokenSetList">
          EXISTS (SELECT JO.JGI_NO
                    FROM DPS_S_SY_M_JGI_JOKEN JO
                    WHERE JO.JGI_NO = JM.JGI_NO
                  <isNotNull property="jokenSetList">
                      <iterate prepend="AND JOKEN_SET_CD IN" open="(" close=")" conjunction=","  property="jokenSetList">
                          #jokenSetList[].dbValue#
                      </iterate>
                  </isNotNull>
                 )
      </isNotNull>
    ORDER BY
      SHOKUSEI_CD, SHOKUSHU_CD, DECODE(JGI_KB, '1','0', JGI_KB), JGI_NO
</select>

  <select id="lastUpDate" resultClass="java.util.Date" >
    SELECT MAX(DATA_UP_DATE) FROM DPM_S_TABLE_MANAGE WHERE TABLE_NAME IN ('DPM_I_CHOSEI_IYAKU', 'DPM_I_CHOSEI_BRANCH', 'DPM_I_CHOSEI_OFFICE', 'DPM_I_CHOSEI_TEAM', 'DPM_I_CHOSEI_MR')
  </select>

</sqlMap>